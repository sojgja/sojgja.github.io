<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sử dụng message queues để xây dựng scalable, reliable trading systems với RabbitMQ, Kafka và event-driven patterns.
"><meta name=author content=soigia><link href=https://sojgja.github.io/blog/2025/01/25/message-queues-cho-trading-systems---rabbitmq-kafka-v%C3%A0-event-driven-architecture/ rel=canonical><link href=../pattern-recognition-trong-trading---ph%C3%A1t-hi%E1%BB%87n-chart-patterns-v%E1%BB%9Bi-python/ rel=prev><link href=../thi%E1%BA%BFt-k%E1%BA%BF-low-latency-trading-system---t%E1%BB%91i-%C6%B0u-t%E1%BB%ABng-microsecond/ rel=next><link rel=icon href=../../../../../assets/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Message Queues cho Trading Systems - RabbitMQ, Kafka và Event-Driven Architecture - soi gia</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../../stylesheets/extra.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#message-queues-cho-trading-systems class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../.. title="soi gia" class="md-header__button md-logo" aria-label="soi gia" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> soi gia </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Message Queues cho Trading Systems - RabbitMQ, Kafka và Event-Driven Architecture </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/sojgja/sojgja.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> sojgja.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../../ class=md-tabs__link> Blog </a> </li> <li class=md-tabs__item> <a href=../../../../../python/ class=md-tabs__link> Python </a> </li> <li class=md-tabs__item> <a href=../../../../../resources/nssm/ class=md-tabs__link> Resources </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="soi gia" class="md-nav__button md-logo" aria-label="soi gia" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> soi gia </label> <div class=md-nav__source> <a href=https://github.com/sojgja/sojgja.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> sojgja.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../../../../ class="md-nav__link "> <span class=md-ellipsis> Blog </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../setup/ class=md-nav__link> <span class=md-ellipsis> Setup </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../archive/2025/ class=md-nav__link> <span class=md-ellipsis> 2025 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex> <span class=md-ellipsis> Categories </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Categories </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../category/api-development/ class=md-nav__link> <span class=md-ellipsis> API Development </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/api-integration/ class=md-nav__link> <span class=md-ellipsis> API Integration </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/algorithmic-trading/ class=md-nav__link> <span class=md-ellipsis> Algorithmic Trading </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/backend-development/ class=md-nav__link> <span class=md-ellipsis> Backend Development </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/backtesting/ class=md-nav__link> <span class=md-ellipsis> Backtesting </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/case-study/ class=md-nav__link> <span class=md-ellipsis> Case Study </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/data-engineering/ class=md-nav__link> <span class=md-ellipsis> Data Engineering </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/database-design/ class=md-nav__link> <span class=md-ellipsis> Database Design </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/general/ class=md-nav__link> <span class=md-ellipsis> General </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/machine-learning/ class=md-nav__link> <span class=md-ellipsis> Machine Learning </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/performance/ class=md-nav__link> <span class=md-ellipsis> Performance </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/python/ class=md-nav__link> <span class=md-ellipsis> Python </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/real-time-systems/ class=md-nav__link> <span class=md-ellipsis> Real-time Systems </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/risk-management/ class=md-nav__link> <span class=md-ellipsis> Risk Management </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/system-architecture/ class=md-nav__link> <span class=md-ellipsis> System Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/technical-analysis/ class=md-nav__link> <span class=md-ellipsis> Technical Analysis </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/trading/ class=md-nav__link> <span class=md-ellipsis> Trading </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/trading-infrastructure/ class=md-nav__link> <span class=md-ellipsis> Trading Infrastructure </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/visualization/ class=md-nav__link> <span class=md-ellipsis> Visualization </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../../../../python/ class="md-nav__link "> <span class=md-ellipsis> Python </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../python/pandas/ class=md-nav__link> <span class=md-ellipsis> Pandas </span> </a> </li> <li class=md-nav__item> <a href=../../../../../python/python-core/ class=md-nav__link> <span class=md-ellipsis> Python core </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../resources/nssm/ class=md-nav__link> <span class=md-ellipsis> nssm </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#tai-sao-can-message-queues class=md-nav__link> <span class=md-ellipsis> Tại sao cần Message Queues? </span> </a> </li> <li class=md-nav__item> <a href=#message-queue-options class=md-nav__link> <span class=md-ellipsis> Message Queue Options </span> </a> <nav class=md-nav aria-label="Message Queue Options"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-rabbitmq class=md-nav__link> <span class=md-ellipsis> 1. RabbitMQ </span> </a> </li> <li class=md-nav__item> <a href=#2-apache-kafka class=md-nav__link> <span class=md-ellipsis> 2. Apache Kafka </span> </a> </li> <li class=md-nav__item> <a href=#3-redis-streams class=md-nav__link> <span class=md-ellipsis> 3. Redis Streams </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#buoc-1-rabbitmq-setup class=md-nav__link> <span class=md-ellipsis> Bước 1: RabbitMQ Setup </span> </a> </li> <li class=md-nav__item> <a href=#buoc-2-trading-event-publisher class=md-nav__link> <span class=md-ellipsis> Bước 2: Trading Event Publisher </span> </a> </li> <li class=md-nav__item> <a href=#buoc-3-event-consumers class=md-nav__link> <span class=md-ellipsis> Bước 3: Event Consumers </span> </a> </li> <li class=md-nav__item> <a href=#buoc-4-kafka-producer class=md-nav__link> <span class=md-ellipsis> Bước 4: Kafka Producer </span> </a> </li> <li class=md-nav__item> <a href=#buoc-5-kafka-consumer class=md-nav__link> <span class=md-ellipsis> Bước 5: Kafka Consumer </span> </a> </li> <li class=md-nav__item> <a href=#buoc-6-event-driven-trading-system class=md-nav__link> <span class=md-ellipsis> Bước 6: Event-Driven Trading System </span> </a> </li> <li class=md-nav__item> <a href=#best-practices class=md-nav__link> <span class=md-ellipsis> Best Practices </span> </a> </li> <li class=md-nav__item> <a href=#ket-luan class=md-nav__link> <span class=md-ellipsis> Kết luận </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../../ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> <span class=md-ellipsis> Back to index </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src=https://avatars.githubusercontent.com/u/932156 alt="soigia lang thang"> </span> <span class=md-profile__description> <strong> <a href=https://github.com/soigia>soigia lang thang</a> </strong> <br> Solution Architecture </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> Metadata </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <time datetime="2025-01-25 00:00:00+00:00" class=md-ellipsis>January 25, 2025</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg> <span class=md-ellipsis> in <a href=../../../../category/trading-infrastructure/ >Trading Infrastructure</a>, <a href=../../../../category/system-architecture/ >System Architecture</a></span> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg> <span class=md-ellipsis> 7 min read </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <a href=https://github.com/sojgja/sojgja.github.io/edit/master/docs/blog/posts/message-queues-trading.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/sojgja/sojgja.github.io/raw/master/docs/blog/posts/message-queues-trading.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=message-queues-cho-trading-systems>Message Queues cho Trading Systems<a class=headerlink href=#message-queues-cho-trading-systems title="Permanent link">&para;</a></h1> <p><img alt="Message Queue Architecture" src="https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=1200&h=600&fit=crop"></p> <p>Trong kiến trúc của modern trading systems, message queues đóng vai trò như những đường ống dẫn quan trọng, kết nối các components khác nhau và đảm bảo dữ liệu được truyền tải một cách reliable, scalable, và efficient. Không giống như synchronous request-response patterns, message queues cho phép các services giao tiếp với nhau một cách asynchronous, decoupling producers và consumers, cho phép hệ thống scale từng component độc lập, và quan trọng nhất là đảm bảo không mất dữ liệu ngay cả khi một component tạm thời không available. Trong trading systems, nơi mà market data có thể đến với tốc độ hàng nghìn messages mỗi giây, và việc mất một message có thể dẫn đến quyết định trading sai lầm, message queues không chỉ là một nice-to-have mà là một requirement thiết yếu.</p> <p>Trong bài viết chi tiết này, chúng ta sẽ cùng nhau khám phá cách sử dụng message queues trong trading systems, từ việc lựa chọn message queue phù hợp (RabbitMQ cho simple use cases, Apache Kafka cho high-throughput scenarios, Redis Streams cho low-latency requirements), thiết kế message schemas và routing strategies, implement producers và consumers, đến việc xử lý các edge cases như message ordering, duplicate detection, và dead letter queues. Chúng ta sẽ học cách implement các patterns phổ biến như pub/sub để broadcast market data đến nhiều consumers, request-reply patterns cho synchronous operations, và event sourcing để maintain state. Chúng ta cũng sẽ thảo luận về các trade-offs giữa different message queue technologies và khi nào nên sử dụng cái nào.</p> <p>Bài viết này sẽ hướng dẫn bạn từng bước một, từ việc setup message queue infrastructure, thiết kế message schemas và topics, implement producers và consumers với error handling và retry logic, đến việc monitor và optimize performance. Chúng ta cũng sẽ học cách handle backpressure khi consumers không thể keep up với producers, implement message prioritization, và scale systems horizontally. Cuối cùng, bạn sẽ có trong tay kiến thức và tools cần thiết để xây dựng trading systems có khả năng scale và reliable cao.</p> <!-- more --> <h2 id=tai-sao-can-message-queues>Tại sao cần Message Queues?<a class=headerlink href=#tai-sao-can-message-queues title="Permanent link">&para;</a></h2> <ol> <li><strong>Decoupling</strong>: Tách các components độc lập</li> <li><strong>Scalability</strong>: Scale từng component riêng biệt</li> <li><strong>Reliability</strong>: Guaranteed delivery, retry mechanisms</li> <li><strong>Buffering</strong>: Handle traffic spikes</li> <li><strong>Asynchronous Processing</strong>: Non-blocking operations</li> </ol> <h2 id=message-queue-options>Message Queue Options<a class=headerlink href=#message-queue-options title="Permanent link">&para;</a></h2> <h3 id=1-rabbitmq>1. RabbitMQ<a class=headerlink href=#1-rabbitmq title="Permanent link">&para;</a></h3> <ul> <li><strong>Pros</strong>: Easy setup, good for simple use cases</li> <li><strong>Cons</strong>: Performance limitations at very high throughput</li> </ul> <h3 id=2-apache-kafka>2. Apache Kafka<a class=headerlink href=#2-apache-kafka title="Permanent link">&para;</a></h3> <ul> <li><strong>Pros</strong>: High throughput, distributed, durable</li> <li><strong>Cons</strong>: More complex, overkill for simple cases</li> </ul> <h3 id=3-redis-streams>3. Redis Streams<a class=headerlink href=#3-redis-streams title="Permanent link">&para;</a></h3> <ul> <li><strong>Pros</strong>: Simple, fast, good for real-time</li> <li><strong>Cons</strong>: Less features than dedicated MQ</li> </ul> <h2 id=buoc-1-rabbitmq-setup>Bước 1: RabbitMQ Setup<a class=headerlink href=#buoc-1-rabbitmq-setup title="Permanent link">&para;</a></h2> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># messaging/rabbitmq_setup.py</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>import</span><span class=w> </span><span class=nn>pika</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>import</span><span class=w> </span><span class=nn>json</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>Optional</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=k>class</span><span class=w> </span><span class=nc>RabbitMQClient</span><span class=p>:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;RabbitMQ client wrapper&quot;&quot;&quot;</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>host</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5672</span><span class=p>,</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>                 <span class=n>username</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;guest&#39;</span><span class=p>,</span> <span class=n>password</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;guest&#39;</span><span class=p>):</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_params</span> <span class=o>=</span> <span class=n>pika</span><span class=o>.</span><span class=n>ConnectionParameters</span><span class=p>(</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>            <span class=n>host</span><span class=o>=</span><span class=n>host</span><span class=p>,</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>            <span class=n>port</span><span class=o>=</span><span class=n>port</span><span class=p>,</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>            <span class=n>credentials</span><span class=o>=</span><span class=n>pika</span><span class=o>.</span><span class=n>PlainCredentials</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>        <span class=p>)</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>        <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>    <span class=k>def</span><span class=w> </span><span class=nf>connect</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Establish connection&quot;&quot;&quot;</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>        <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=o>=</span> <span class=n>pika</span><span class=o>.</span><span class=n>BlockingConnection</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>connection_params</span><span class=p>)</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>channel</span><span class=p>()</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>    <span class=k>def</span><span class=w> </span><span class=nf>declare_exchange</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>exchange_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;topic&#39;</span><span class=p>):</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Declare exchange&quot;&quot;&quot;</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>exchange_declare</span><span class=p>(</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>            <span class=n>exchange</span><span class=o>=</span><span class=n>exchange</span><span class=p>,</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>            <span class=n>exchange_type</span><span class=o>=</span><span class=n>exchange_type</span><span class=p>,</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a>            <span class=n>durable</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a>        <span class=p>)</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a>    <span class=k>def</span><span class=w> </span><span class=nf>declare_queue</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>queue</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Declare queue&quot;&quot;&quot;</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>queue_declare</span><span class=p>(</span><span class=n>queue</span><span class=o>=</span><span class=n>queue</span><span class=p>,</span> <span class=n>durable</span><span class=o>=</span><span class=n>durable</span><span class=p>)</span>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a>    <span class=k>def</span><span class=w> </span><span class=nf>bind_queue</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>queue</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Bind queue to exchange&quot;&quot;&quot;</span>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>queue_bind</span><span class=p>(</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a>            <span class=n>queue</span><span class=o>=</span><span class=n>queue</span><span class=p>,</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a>            <span class=n>exchange</span><span class=o>=</span><span class=n>exchange</span><span class=p>,</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a>            <span class=n>routing_key</span><span class=o>=</span><span class=n>routing_key</span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a>        <span class=p>)</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a>    <span class=k>def</span><span class=w> </span><span class=nf>publish</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Publish message&quot;&quot;&quot;</span>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>basic_publish</span><span class=p>(</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a>            <span class=n>exchange</span><span class=o>=</span><span class=n>exchange</span><span class=p>,</span>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a>            <span class=n>routing_key</span><span class=o>=</span><span class=n>routing_key</span><span class=p>,</span>
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51 href=#__codelineno-0-51></a>            <span class=n>body</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>message</span><span class=p>),</span>
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52 href=#__codelineno-0-52></a>            <span class=n>properties</span><span class=o>=</span><span class=n>pika</span><span class=o>.</span><span class=n>BasicProperties</span><span class=p>(</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53 href=#__codelineno-0-53></a>                <span class=n>delivery_mode</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>  <span class=c1># Make message persistent</span>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54 href=#__codelineno-0-54></a>            <span class=p>)</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55 href=#__codelineno-0-55></a>        <span class=p>)</span>
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56 href=#__codelineno-0-56></a>
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57 href=#__codelineno-0-57></a>    <span class=k>def</span><span class=w> </span><span class=nf>consume</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>queue</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>callback</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>auto_ack</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>):</span>
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58 href=#__codelineno-0-58></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Consume messages&quot;&quot;&quot;</span>
</span><span id=__span-0-59><a id=__codelineno-0-59 name=__codelineno-0-59 href=#__codelineno-0-59></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>basic_consume</span><span class=p>(</span>
</span><span id=__span-0-60><a id=__codelineno-0-60 name=__codelineno-0-60 href=#__codelineno-0-60></a>            <span class=n>queue</span><span class=o>=</span><span class=n>queue</span><span class=p>,</span>
</span><span id=__span-0-61><a id=__codelineno-0-61 name=__codelineno-0-61 href=#__codelineno-0-61></a>            <span class=n>on_message_callback</span><span class=o>=</span><span class=n>callback</span><span class=p>,</span>
</span><span id=__span-0-62><a id=__codelineno-0-62 name=__codelineno-0-62 href=#__codelineno-0-62></a>            <span class=n>auto_ack</span><span class=o>=</span><span class=n>auto_ack</span>
</span><span id=__span-0-63><a id=__codelineno-0-63 name=__codelineno-0-63 href=#__codelineno-0-63></a>        <span class=p>)</span>
</span><span id=__span-0-64><a id=__codelineno-0-64 name=__codelineno-0-64 href=#__codelineno-0-64></a>        <span class=bp>self</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>start_consuming</span><span class=p>()</span>
</span><span id=__span-0-65><a id=__codelineno-0-65 name=__codelineno-0-65 href=#__codelineno-0-65></a>
</span><span id=__span-0-66><a id=__codelineno-0-66 name=__codelineno-0-66 href=#__codelineno-0-66></a>    <span class=k>def</span><span class=w> </span><span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-67><a id=__codelineno-0-67 name=__codelineno-0-67 href=#__codelineno-0-67></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Close connection&quot;&quot;&quot;</span>
</span><span id=__span-0-68><a id=__codelineno-0-68 name=__codelineno-0-68 href=#__codelineno-0-68></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>is_closed</span><span class=p>:</span>
</span><span id=__span-0-69><a id=__codelineno-0-69 name=__codelineno-0-69 href=#__codelineno-0-69></a>            <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></code></pre></div> <h2 id=buoc-2-trading-event-publisher>Bước 2: Trading Event Publisher<a class=headerlink href=#buoc-2-trading-event-publisher title="Permanent link">&para;</a></h2> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># messaging/trading_events.py</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kn>from</span><span class=w> </span><span class=nn>messaging.rabbitmq_setup</span><span class=w> </span><span class=kn>import</span> <span class=n>RabbitMQClient</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=k>class</span><span class=w> </span><span class=nc>TradingEventPublisher</span><span class=p>:</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Publish trading events to message queue&quot;&quot;&quot;</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rabbitmq</span><span class=p>:</span> <span class=n>RabbitMQClient</span><span class=p>):</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span> <span class=o>=</span> <span class=n>rabbitmq</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>exchange</span> <span class=o>=</span> <span class=s1>&#39;trading_events&#39;</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>        <span class=c1># Setup exchange</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>declare_exchange</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>exchange</span><span class=p>,</span> <span class=s1>&#39;topic&#39;</span><span class=p>)</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>    <span class=k>def</span><span class=w> </span><span class=nf>publish_ticker_update</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>price</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Publish ticker update event&quot;&quot;&quot;</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>        <span class=n>event</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;ticker_update&#39;</span><span class=p>,</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>            <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>            <span class=s1>&#39;exchange&#39;</span><span class=p>:</span> <span class=n>exchange</span><span class=p>,</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a>            <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>price</span><span class=p>,</span>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>        <span class=p>}</span>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a>        <span class=n>routing_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;ticker.</span><span class=si>{</span><span class=n>exchange</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>exchange</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Published ticker update: </span><span class=si>{</span><span class=n>routing_key</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a>
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a>    <span class=k>def</span><span class=w> </span><span class=nf>publish_trade_executed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a>                             <span class=n>price</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>side</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Publish trade executed event&quot;&quot;&quot;</span>
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a>        <span class=n>event</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;trade_executed&#39;</span><span class=p>,</span>
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a>            <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span>
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a>            <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a>            <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>price</span><span class=p>,</span>
</span><span id=__span-1-39><a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a>            <span class=s1>&#39;quantity&#39;</span><span class=p>:</span> <span class=n>quantity</span><span class=p>,</span>
</span><span id=__span-1-40><a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a>            <span class=s1>&#39;side&#39;</span><span class=p>:</span> <span class=n>side</span><span class=p>,</span>
</span><span id=__span-1-41><a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span><span id=__span-1-42><a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a>        <span class=p>}</span>
</span><span id=__span-1-43><a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a>
</span><span id=__span-1-44><a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a>        <span class=n>routing_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;trade.</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-45><a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>exchange</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
</span><span id=__span-1-46><a id=__codelineno-1-46 name=__codelineno-1-46 href=#__codelineno-1-46></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Published trade executed: </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-1-47><a id=__codelineno-1-47 name=__codelineno-1-47 href=#__codelineno-1-47></a>
</span><span id=__span-1-48><a id=__codelineno-1-48 name=__codelineno-1-48 href=#__codelineno-1-48></a>    <span class=k>def</span><span class=w> </span><span class=nf>publish_signal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>strength</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span><span id=__span-1-49><a id=__codelineno-1-49 name=__codelineno-1-49 href=#__codelineno-1-49></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Publish trading signal&quot;&quot;&quot;</span>
</span><span id=__span-1-50><a id=__codelineno-1-50 name=__codelineno-1-50 href=#__codelineno-1-50></a>        <span class=n>event</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-1-51><a id=__codelineno-1-51 name=__codelineno-1-51 href=#__codelineno-1-51></a>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;signal&#39;</span><span class=p>,</span>
</span><span id=__span-1-52><a id=__codelineno-1-52 name=__codelineno-1-52 href=#__codelineno-1-52></a>            <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span><span id=__span-1-53><a id=__codelineno-1-53 name=__codelineno-1-53 href=#__codelineno-1-53></a>            <span class=s1>&#39;signal&#39;</span><span class=p>:</span> <span class=n>signal</span><span class=p>,</span>  <span class=c1># &#39;BUY&#39;, &#39;SELL&#39;, &#39;HOLD&#39;</span>
</span><span id=__span-1-54><a id=__codelineno-1-54 name=__codelineno-1-54 href=#__codelineno-1-54></a>            <span class=s1>&#39;strength&#39;</span><span class=p>:</span> <span class=n>strength</span><span class=p>,</span>
</span><span id=__span-1-55><a id=__codelineno-1-55 name=__codelineno-1-55 href=#__codelineno-1-55></a>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span><span id=__span-1-56><a id=__codelineno-1-56 name=__codelineno-1-56 href=#__codelineno-1-56></a>        <span class=p>}</span>
</span><span id=__span-1-57><a id=__codelineno-1-57 name=__codelineno-1-57 href=#__codelineno-1-57></a>
</span><span id=__span-1-58><a id=__codelineno-1-58 name=__codelineno-1-58 href=#__codelineno-1-58></a>        <span class=n>routing_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;signal.</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-59><a id=__codelineno-1-59 name=__codelineno-1-59 href=#__codelineno-1-59></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>exchange</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
</span><span id=__span-1-60><a id=__codelineno-1-60 name=__codelineno-1-60 href=#__codelineno-1-60></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Published signal: </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>signal</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <h2 id=buoc-3-event-consumers>Bước 3: Event Consumers<a class=headerlink href=#buoc-3-event-consumers title="Permanent link">&para;</a></h2> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># messaging/event_consumers.py</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=kn>from</span><span class=w> </span><span class=nn>messaging.rabbitmq_setup</span><span class=w> </span><span class=kn>import</span> <span class=n>RabbitMQClient</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=kn>import</span><span class=w> </span><span class=nn>json</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=k>class</span><span class=w> </span><span class=nc>TradingEventConsumer</span><span class=p>:</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Consume trading events&quot;&quot;&quot;</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rabbitmq</span><span class=p>:</span> <span class=n>RabbitMQClient</span><span class=p>):</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span> <span class=o>=</span> <span class=n>rabbitmq</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>exchange</span> <span class=o>=</span> <span class=s1>&#39;trading_events&#39;</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>    <span class=k>def</span><span class=w> </span><span class=nf>setup_ticker_consumer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>queue</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Setup consumer for ticker updates&quot;&quot;&quot;</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>declare_queue</span><span class=p>(</span><span class=n>queue</span><span class=p>)</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>bind_queue</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>exchange</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>)</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>        <span class=k>def</span><span class=w> </span><span class=nf>callback</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>properties</span><span class=p>,</span> <span class=n>body</span><span class=p>):</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>                <span class=n>event</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>body</span><span class=p>)</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>                <span class=bp>self</span><span class=o>.</span><span class=n>handle_ticker_update</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>                <span class=n>ch</span><span class=o>.</span><span class=n>basic_ack</span><span class=p>(</span><span class=n>delivery_tag</span><span class=o>=</span><span class=n>method</span><span class=o>.</span><span class=n>delivery_tag</span><span class=p>)</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error processing ticker: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a>                <span class=n>ch</span><span class=o>.</span><span class=n>basic_nack</span><span class=p>(</span><span class=n>delivery_tag</span><span class=o>=</span><span class=n>method</span><span class=o>.</span><span class=n>delivery_tag</span><span class=p>,</span> <span class=n>requeue</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>basic_consume</span><span class=p>(</span>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a>            <span class=n>queue</span><span class=o>=</span><span class=n>queue</span><span class=p>,</span>
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a>            <span class=n>on_message_callback</span><span class=o>=</span><span class=n>callback</span>
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a>        <span class=p>)</span>
</span><span id=__span-2-33><a id=__codelineno-2-33 name=__codelineno-2-33 href=#__codelineno-2-33></a>
</span><span id=__span-2-34><a id=__codelineno-2-34 name=__codelineno-2-34 href=#__codelineno-2-34></a>    <span class=k>def</span><span class=w> </span><span class=nf>setup_trade_consumer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>queue</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-2-35><a id=__codelineno-2-35 name=__codelineno-2-35 href=#__codelineno-2-35></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Setup consumer for trade events&quot;&quot;&quot;</span>
</span><span id=__span-2-36><a id=__codelineno-2-36 name=__codelineno-2-36 href=#__codelineno-2-36></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>declare_queue</span><span class=p>(</span><span class=n>queue</span><span class=p>)</span>
</span><span id=__span-2-37><a id=__codelineno-2-37 name=__codelineno-2-37 href=#__codelineno-2-37></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>bind_queue</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>exchange</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>)</span>
</span><span id=__span-2-38><a id=__codelineno-2-38 name=__codelineno-2-38 href=#__codelineno-2-38></a>
</span><span id=__span-2-39><a id=__codelineno-2-39 name=__codelineno-2-39 href=#__codelineno-2-39></a>        <span class=k>def</span><span class=w> </span><span class=nf>callback</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>properties</span><span class=p>,</span> <span class=n>body</span><span class=p>):</span>
</span><span id=__span-2-40><a id=__codelineno-2-40 name=__codelineno-2-40 href=#__codelineno-2-40></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-2-41><a id=__codelineno-2-41 name=__codelineno-2-41 href=#__codelineno-2-41></a>                <span class=n>event</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>body</span><span class=p>)</span>
</span><span id=__span-2-42><a id=__codelineno-2-42 name=__codelineno-2-42 href=#__codelineno-2-42></a>                <span class=bp>self</span><span class=o>.</span><span class=n>handle_trade_executed</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span><span id=__span-2-43><a id=__codelineno-2-43 name=__codelineno-2-43 href=#__codelineno-2-43></a>                <span class=n>ch</span><span class=o>.</span><span class=n>basic_ack</span><span class=p>(</span><span class=n>delivery_tag</span><span class=o>=</span><span class=n>method</span><span class=o>.</span><span class=n>delivery_tag</span><span class=p>)</span>
</span><span id=__span-2-44><a id=__codelineno-2-44 name=__codelineno-2-44 href=#__codelineno-2-44></a>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-2-45><a id=__codelineno-2-45 name=__codelineno-2-45 href=#__codelineno-2-45></a>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error processing trade: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-2-46><a id=__codelineno-2-46 name=__codelineno-2-46 href=#__codelineno-2-46></a>                <span class=n>ch</span><span class=o>.</span><span class=n>basic_nack</span><span class=p>(</span><span class=n>delivery_tag</span><span class=o>=</span><span class=n>method</span><span class=o>.</span><span class=n>delivery_tag</span><span class=p>,</span> <span class=n>requeue</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-2-47><a id=__codelineno-2-47 name=__codelineno-2-47 href=#__codelineno-2-47></a>
</span><span id=__span-2-48><a id=__codelineno-2-48 name=__codelineno-2-48 href=#__codelineno-2-48></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>basic_consume</span><span class=p>(</span>
</span><span id=__span-2-49><a id=__codelineno-2-49 name=__codelineno-2-49 href=#__codelineno-2-49></a>            <span class=n>queue</span><span class=o>=</span><span class=n>queue</span><span class=p>,</span>
</span><span id=__span-2-50><a id=__codelineno-2-50 name=__codelineno-2-50 href=#__codelineno-2-50></a>            <span class=n>on_message_callback</span><span class=o>=</span><span class=n>callback</span>
</span><span id=__span-2-51><a id=__codelineno-2-51 name=__codelineno-2-51 href=#__codelineno-2-51></a>        <span class=p>)</span>
</span><span id=__span-2-52><a id=__codelineno-2-52 name=__codelineno-2-52 href=#__codelineno-2-52></a>
</span><span id=__span-2-53><a id=__codelineno-2-53 name=__codelineno-2-53 href=#__codelineno-2-53></a>    <span class=k>def</span><span class=w> </span><span class=nf>handle_ticker_update</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span><span id=__span-2-54><a id=__codelineno-2-54 name=__codelineno-2-54 href=#__codelineno-2-54></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Handle ticker update&quot;&quot;&quot;</span>
</span><span id=__span-2-55><a id=__codelineno-2-55 name=__codelineno-2-55 href=#__codelineno-2-55></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Ticker update: </span><span class=si>{</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> = $</span><span class=si>{</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-2-56><a id=__codelineno-2-56 name=__codelineno-2-56 href=#__codelineno-2-56></a>        <span class=c1># Update database, cache, etc.</span>
</span><span id=__span-2-57><a id=__codelineno-2-57 name=__codelineno-2-57 href=#__codelineno-2-57></a>
</span><span id=__span-2-58><a id=__codelineno-2-58 name=__codelineno-2-58 href=#__codelineno-2-58></a>    <span class=k>def</span><span class=w> </span><span class=nf>handle_trade_executed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span><span id=__span-2-59><a id=__codelineno-2-59 name=__codelineno-2-59 href=#__codelineno-2-59></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Handle trade executed&quot;&quot;&quot;</span>
</span><span id=__span-2-60><a id=__codelineno-2-60 name=__codelineno-2-60 href=#__codelineno-2-60></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Trade executed: </span><span class=si>{</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-2-61><a id=__codelineno-2-61 name=__codelineno-2-61 href=#__codelineno-2-61></a>        <span class=c1># Update portfolio, send notifications, etc.</span>
</span></code></pre></div> <h2 id=buoc-4-kafka-producer>Bước 4: Kafka Producer<a class=headerlink href=#buoc-4-kafka-producer title="Permanent link">&para;</a></h2> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1># messaging/kafka_producer.py</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kn>from</span><span class=w> </span><span class=nn>kafka</span><span class=w> </span><span class=kn>import</span> <span class=n>KafkaProducer</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=kn>import</span><span class=w> </span><span class=nn>json</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=k>class</span><span class=w> </span><span class=nc>KafkaTradingProducer</span><span class=p>:</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Kafka producer for trading events&quot;&quot;&quot;</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bootstrap_servers</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span> <span class=o>=</span> <span class=n>KafkaProducer</span><span class=p>(</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>            <span class=n>bootstrap_servers</span><span class=o>=</span><span class=n>bootstrap_servers</span><span class=p>,</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>            <span class=n>value_serializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>v</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>            <span class=n>acks</span><span class=o>=</span><span class=s1>&#39;all&#39;</span><span class=p>,</span>  <span class=c1># Wait for all replicas</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>            <span class=n>retries</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>            <span class=n>max_in_flight_requests_per_connection</span><span class=o>=</span><span class=mi>1</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>        <span class=p>)</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>    <span class=k>def</span><span class=w> </span><span class=nf>publish_ticker</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>topic</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>price</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Publish ticker to Kafka&quot;&quot;&quot;</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>        <span class=n>message</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>            <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>            <span class=s1>&#39;exchange&#39;</span><span class=p>:</span> <span class=n>exchange</span><span class=p>,</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>            <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>price</span><span class=p>,</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>        <span class=p>}</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>        <span class=n>future</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>topic</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=n>message</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=n>symbol</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>        <span class=c1># Wait for result</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a>            <span class=n>record_metadata</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a>                <span class=sa>f</span><span class=s2>&quot;Published to </span><span class=si>{</span><span class=n>record_metadata</span><span class=o>.</span><span class=n>topic</span><span class=si>}</span><span class=s2> &quot;</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a>                <span class=sa>f</span><span class=s2>&quot;partition </span><span class=si>{</span><span class=n>record_metadata</span><span class=o>.</span><span class=n>partition</span><span class=si>}</span><span class=s2> &quot;</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a>                <span class=sa>f</span><span class=s2>&quot;offset </span><span class=si>{</span><span class=n>record_metadata</span><span class=o>.</span><span class=n>offset</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a>            <span class=p>)</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error publishing: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a>    <span class=k>def</span><span class=w> </span><span class=nf>flush</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Flush pending messages&quot;&quot;&quot;</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a>    <span class=k>def</span><span class=w> </span><span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Close producer&quot;&quot;&quot;</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></code></pre></div> <h2 id=buoc-5-kafka-consumer>Bước 5: Kafka Consumer<a class=headerlink href=#buoc-5-kafka-consumer title="Permanent link">&para;</a></h2> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1># messaging/kafka_consumer.py</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>from</span><span class=w> </span><span class=nn>kafka</span><span class=w> </span><span class=kn>import</span> <span class=n>KafkaConsumer</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=kn>import</span><span class=w> </span><span class=nn>json</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>List</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=k>class</span><span class=w> </span><span class=nc>KafkaTradingConsumer</span><span class=p>:</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Kafka consumer for trading events&quot;&quot;&quot;</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bootstrap_servers</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>group_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span> <span class=o>=</span> <span class=n>KafkaConsumer</span><span class=p>(</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>            <span class=n>bootstrap_servers</span><span class=o>=</span><span class=n>bootstrap_servers</span><span class=p>,</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>            <span class=n>group_id</span><span class=o>=</span><span class=n>group_id</span><span class=p>,</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>            <span class=n>value_deserializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>m</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)),</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>            <span class=n>auto_offset_reset</span><span class=o>=</span><span class=s1>&#39;earliest&#39;</span><span class=p>,</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>            <span class=n>enable_auto_commit</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>        <span class=p>)</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>    <span class=k>def</span><span class=w> </span><span class=nf>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>topics</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Subscribe to topics&quot;&quot;&quot;</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>        <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=n>topics</span><span class=p>)</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>
</span><span id=__span-4-24><a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a>    <span class=k>def</span><span class=w> </span><span class=nf>consume</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>callback</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span><span id=__span-4-25><a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Consume messages&quot;&quot;&quot;</span>
</span><span id=__span-4-26><a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-4-27><a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>            <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span><span class=p>:</span>
</span><span id=__span-4-28><a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>                <span class=k>try</span><span class=p>:</span>
</span><span id=__span-4-29><a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a>                    <span class=n>callback</span><span class=p>(</span><span class=n>message</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span><span id=__span-4-30><a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-4-31><a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-4-32><a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error processing message: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-4-33><a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a>                    <span class=c1># Don&#39;t commit on error</span>
</span><span id=__span-4-34><a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a>        <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span><span id=__span-4-35><a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Consumer stopped&quot;</span><span class=p>)</span>
</span><span id=__span-4-36><a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a>        <span class=k>finally</span><span class=p>:</span>
</span><span id=__span-4-37><a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a>            <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></code></pre></div> <h2 id=buoc-6-event-driven-trading-system>Bước 6: Event-Driven Trading System<a class=headerlink href=#buoc-6-event-driven-trading-system title="Permanent link">&para;</a></h2> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1># messaging/event_driven_system.py</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kn>from</span><span class=w> </span><span class=nn>messaging.trading_events</span><span class=w> </span><span class=kn>import</span> <span class=n>TradingEventPublisher</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=kn>from</span><span class=w> </span><span class=nn>messaging.event_consumers</span><span class=w> </span><span class=kn>import</span> <span class=n>TradingEventConsumer</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kn>from</span><span class=w> </span><span class=nn>messaging.rabbitmq_setup</span><span class=w> </span><span class=kn>import</span> <span class=n>RabbitMQClient</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=k>class</span><span class=w> </span><span class=nc>EventDrivenTradingSystem</span><span class=p>:</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Event-driven trading system&quot;&quot;&quot;</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>        <span class=c1># Setup message queue</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span> <span class=o>=</span> <span class=n>RabbitMQClient</span><span class=p>()</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>        <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>        <span class=c1># Publishers</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>        <span class=bp>self</span><span class=o>.</span><span class=n>event_publisher</span> <span class=o>=</span> <span class=n>TradingEventPublisher</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=p>)</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>        <span class=c1># Consumers</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>        <span class=bp>self</span><span class=o>.</span><span class=n>event_consumer</span> <span class=o>=</span> <span class=n>TradingEventConsumer</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=p>)</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>        <span class=c1># Setup consumers</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_consumers</span><span class=p>()</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>    <span class=k>def</span><span class=w> </span><span class=nf>setup_consumers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Setup all consumers&quot;&quot;&quot;</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>        <span class=c1># Ticker consumer</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>        <span class=bp>self</span><span class=o>.</span><span class=n>event_consumer</span><span class=o>.</span><span class=n>setup_ticker_consumer</span><span class=p>(</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>            <span class=s1>&#39;ticker_updates&#39;</span><span class=p>,</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>            <span class=s1>&#39;ticker.*.*&#39;</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>        <span class=p>)</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a>        <span class=c1># Trade consumer</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a>        <span class=bp>self</span><span class=o>.</span><span class=n>event_consumer</span><span class=o>.</span><span class=n>setup_trade_consumer</span><span class=p>(</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a>            <span class=s1>&#39;trade_executions&#39;</span><span class=p>,</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a>            <span class=s1>&#39;trade.*&#39;</span>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a>        <span class=p>)</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a>
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a>    <span class=k>def</span><span class=w> </span><span class=nf>start_consumers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Start consuming in background thread&quot;&quot;&quot;</span>
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a>        <span class=k>def</span><span class=w> </span><span class=nf>run</span><span class=p>():</span>
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41 href=#__codelineno-5-41></a>            <span class=bp>self</span><span class=o>.</span><span class=n>mq</span><span class=o>.</span><span class=n>channel</span><span class=o>.</span><span class=n>start_consuming</span><span class=p>()</span>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42 href=#__codelineno-5-42></a>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43 href=#__codelineno-5-43></a>        <span class=n>thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>run</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44 href=#__codelineno-5-44></a>        <span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45 href=#__codelineno-5-45></a>
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46 href=#__codelineno-5-46></a>    <span class=k>def</span><span class=w> </span><span class=nf>publish_ticker</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>exchange</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>price</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47 href=#__codelineno-5-47></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Publish ticker update&quot;&quot;&quot;</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48 href=#__codelineno-5-48></a>        <span class=bp>self</span><span class=o>.</span><span class=n>event_publisher</span><span class=o>.</span><span class=n>publish_ticker_update</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>exchange</span><span class=p>,</span> <span class=n>price</span><span class=p>)</span>
</span><span id=__span-5-49><a id=__codelineno-5-49 name=__codelineno-5-49 href=#__codelineno-5-49></a>
</span><span id=__span-5-50><a id=__codelineno-5-50 name=__codelineno-5-50 href=#__codelineno-5-50></a>    <span class=k>def</span><span class=w> </span><span class=nf>publish_trade</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>price</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
</span><span id=__span-5-51><a id=__codelineno-5-51 name=__codelineno-5-51 href=#__codelineno-5-51></a>                     <span class=n>quantity</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>side</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-5-52><a id=__codelineno-5-52 name=__codelineno-5-52 href=#__codelineno-5-52></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Publish trade&quot;&quot;&quot;</span>
</span><span id=__span-5-53><a id=__codelineno-5-53 name=__codelineno-5-53 href=#__codelineno-5-53></a>        <span class=bp>self</span><span class=o>.</span><span class=n>event_publisher</span><span class=o>.</span><span class=n>publish_trade_executed</span><span class=p>(</span>
</span><span id=__span-5-54><a id=__codelineno-5-54 name=__codelineno-5-54 href=#__codelineno-5-54></a>            <span class=n>order_id</span><span class=p>,</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>price</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>side</span>
</span><span id=__span-5-55><a id=__codelineno-5-55 name=__codelineno-5-55 href=#__codelineno-5-55></a>        <span class=p>)</span>
</span><span id=__span-5-56><a id=__codelineno-5-56 name=__codelineno-5-56 href=#__codelineno-5-56></a>
</span><span id=__span-5-57><a id=__codelineno-5-57 name=__codelineno-5-57 href=#__codelineno-5-57></a><span class=c1># Usage</span>
</span><span id=__span-5-58><a id=__codelineno-5-58 name=__codelineno-5-58 href=#__codelineno-5-58></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span><span id=__span-5-59><a id=__codelineno-5-59 name=__codelineno-5-59 href=#__codelineno-5-59></a>    <span class=n>system</span> <span class=o>=</span> <span class=n>EventDrivenTradingSystem</span><span class=p>()</span>
</span><span id=__span-5-60><a id=__codelineno-5-60 name=__codelineno-5-60 href=#__codelineno-5-60></a>    <span class=n>system</span><span class=o>.</span><span class=n>start_consumers</span><span class=p>()</span>
</span><span id=__span-5-61><a id=__codelineno-5-61 name=__codelineno-5-61 href=#__codelineno-5-61></a>
</span><span id=__span-5-62><a id=__codelineno-5-62 name=__codelineno-5-62 href=#__codelineno-5-62></a>    <span class=c1># Publish events</span>
</span><span id=__span-5-63><a id=__codelineno-5-63 name=__codelineno-5-63 href=#__codelineno-5-63></a>    <span class=n>system</span><span class=o>.</span><span class=n>publish_ticker</span><span class=p>(</span><span class=s1>&#39;BTCUSDT&#39;</span><span class=p>,</span> <span class=s1>&#39;binance&#39;</span><span class=p>,</span> <span class=mi>50000</span><span class=p>)</span>
</span><span id=__span-5-64><a id=__codelineno-5-64 name=__codelineno-5-64 href=#__codelineno-5-64></a>    <span class=n>system</span><span class=o>.</span><span class=n>publish_trade</span><span class=p>(</span><span class=s1>&#39;order123&#39;</span><span class=p>,</span> <span class=s1>&#39;BTCUSDT&#39;</span><span class=p>,</span> <span class=mi>50000</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>,</span> <span class=s1>&#39;BUY&#39;</span><span class=p>)</span>
</span></code></pre></div> <h2 id=best-practices>Best Practices<a class=headerlink href=#best-practices title="Permanent link">&para;</a></h2> <ol> <li><strong>Message Durability</strong>: Enable persistence for critical messages</li> <li><strong>Acknowledgment</strong>: Use manual ack for reliability</li> <li><strong>Error Handling</strong>: Implement retry and dead letter queues</li> <li><strong>Idempotency</strong>: Make consumers idempotent</li> <li><strong>Partitioning</strong>: Partition by symbol for better parallelism</li> <li><strong>Monitoring</strong>: Monitor queue depth, consumer lag</li> <li><strong>Backpressure</strong>: Handle when consumers are slow</li> </ol> <h2 id=ket-luan>Kết luận<a class=headerlink href=#ket-luan title="Permanent link">&para;</a></h2> <p>Message queues enable: - Scalable architecture - Reliable message delivery - Decoupled components - Better fault tolerance</p> <p>Chọn message queue phù hợp với requirements của bạn!</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../pattern-recognition-trong-trading---ph%C3%A1t-hi%E1%BB%87n-chart-patterns-v%E1%BB%9Bi-python/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Pattern Recognition trong Trading - Phát hiện Chart Patterns với Python"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Pattern Recognition trong Trading - Phát hiện Chart Patterns với Python </div> </div> </a> <a href=../thi%E1%BA%BFt-k%E1%BA%BF-low-latency-trading-system---t%E1%BB%91i-%C6%B0u-t%E1%BB%ABng-microsecond/ class="md-footer__link md-footer__link--next" aria-label="Next: Thiết kế Low-Latency Trading System - Tối ưu từng microsecond"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Thiết kế Low-Latency Trading System - Tối ưu từng microsecond </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2016 - 2025 soigia </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/sojgja target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://hub.docker.com/r/sojgja/ target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg> </a> <a href=https://pypi.org/project/sojgja/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> <a href=https://bsky.app/profile/sojgja target=_blank rel=noopener title=bsky.app class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M407.8 294.7c-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3M288 227.1c-26.1-50.7-97.1-145.2-163.1-191.8C61.6-9.4 37.5-1.7 21.6 5.5 3.3 13.8 0 41.9 0 58.4S9.1 194 15 213.9c19.5 65.7 89.1 87.9 153.2 80.7 3.3-.5 6.6-.9 10-1.4-3.3.5-6.6 1-10 1.4-93.9 14-177.3 48.2-67.9 169.9C220.6 589.1 265.1 437.8 288 361.1c22.9 76.7 49.2 222.5 185.6 103.4 102.4-103.4 28.1-156-65.8-169.9-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3 64.1 7.1 133.6-15.1 153.2-80.7C566.9 194 576 75 576 58.4s-3.3-44.7-21.6-52.9c-15.8-7.1-40-14.9-103.2 29.8C385.1 81.9 314.1 176.4 288 227.1"/></svg> </a> <a href=https://fosstodon.org/@sojgja target=_blank rel="noopener me" title=fosstodon.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54-.6-4.6-.9-9.3-.9-13.9 85.6 20.9 158.7 9.1 178.7 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6V190.1c0-49.7-64-51.6-64 6.9v62.5H201V197c0-58.5-64-56.6-64-6.9v114.2H90.3c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175"/></svg> </a> <a href=https://x.com/sojgja target=_blank rel=noopener title=x.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../../../../..", "features": ["content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "header.autohide", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>